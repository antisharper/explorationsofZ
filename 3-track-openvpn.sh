#!/bin/bash

CYCLETIME=${1:-5}
SERVER=${2:-truenas-10g}
#watch --difference -n $CYCLETIME 'ssh -o ConnectTimeout=5 root@truenas cat /tmp/openvpn-status | sed "s/Bytes //g;/LIST/,/ROUTING/!d;/Common/,/ROUTING/!d;/ROUTING/d" | awk -F, "{side=\"-\"; if (NR > 1) { side=\"\";RECVK=int(\$3/1024);SENTK=int(\$4/1024) }else {RECVK=\$3;SENTK=\$4};printf(\"%-15.15s %\"side\"22.22s %\"side\"15.15s %\"side\"12.12s %\"side\"25.25s\\n\",\$1,\$2,RECVK,SENTK,\$5)}"'

watch --difference -n $CYCLETIME 'echo "             " TRUENAS;ssh -o ConnectTimeout=5 root@truenas cat /tmp/openvpn-status | sed "s/Bytes //g;s/Received/Recv M/g;s/Sent/Sent M/g;/LIST/,/ROUTING/!d;/Common/,/ROUTING/!d;/ROUTING/d" | awk -F, "{ if (NR > 1) { side=\"\"; RECVK=int(\$3/1024/1024); SENTK=int(\$4/1024/1024) } else { RECVK=\$3; SENTK=\$4 }; printf (\"%-15.15s %\"side\"22.22s %\"side\"15.15s %\"side\"12.12s %\"side\"25.25s\\n\",\$1,\$2,RECVK,SENTK,\$5)}" | (sed -u 1q; sort) ; printf "\t\n"; echo ; echo "          " TEST-TRUENAS; ssh -o ConnectTimeout=5 root@192.168.97.120 cat /tmp/openvpn-status | sed "s/Bytes //g;s/Received/Recv M/g;s/Sent/Sent M/g;/LIST/,/ROUTING/!d;/Common/,/ROUTING/!d;/ROUTING/d" | awk -F, "{ if (NR > 1) { side=\"\"; RECVK=int(\$3/1024/1024); SENTK=int(\$4/1024/1024) } else { RECVK=\$3; SENTK=\$4 }; printf (\"%-15.15s %\"side\"22.22s %\"side\"15.15s %\"side\"12.12s %\"side\"25.25s\\n\",\$1,\$2,RECVK,SENTK,\$5)}" | (sed -u 1q; sort); echo ; printf "\t\n" ; echo "          " PI4B-OpenVPN TCP;ssh -o ConnectTimeout=5 pi@192.168.97.119 sudo cat /run/openvpn-server/status-tcp.log | awk -F , "BEGIN {formatstr=\"%-18.18s %21.21s %15.15s %7.7s %7.7s %20.20s\\n\"} /CLIENT_LIST/ { if (DEBUG) {print \$0}; if (\$2 ~ /CLIENT/) { printf(formatstr,\"Common Name\",\"Real Address\",\"Virt Address\",\"Recv M\",\"Sent M\",\"Connected Since\") } else { INST=1; printf(formatstr,\$2,\$3,\$4,int(\$6/1024/1024),int(\$7/1024/1024),\$8)}}" | (sed -u 1q; sort); echo ; printf "\t\n"; echo "         " PI4B-OpenVPN UDP;ssh -o ConnectTimeout=5 pi@192.168.97.119 sudo cat //run/openvpn-server/status-udp.log | awk -F , "BEGIN {formatstr=\"%-18.18s %21.21s %15.15s %7.7s %7.7s %20.20s\\n\"} /CLIENT_LIST/ { if (DEBUG) {print \$0}; if (\$2 ~ /CLIENT/) { printf(formatstr,\"Common Name\",\"Real Address\",\"Virt Address\",\"Recv M\",\"Sent M\",\"Connected Since\") } else { INST=1; printf(formatstr,\$2,\$3,\$4,int(\$6/1024/1024),int(\$7/1024/1024),\$8)}}" | (sed -u 1q; sort)'

#watch --difference -n $CYCLETIME 'bash a-track-openvpn.sh "TrueNAS TCP" root@truenas /tmp/openvpn-status; bash a-track-openvpn.sh "TEST TrueNAS TCP" root@192.168.97.120 /tmp/openvpn-status; bash a-track-openvpn.sh "Pi4B TCP" pi@192.168.97.119 /dev/shm/openvpnserver-status; bash a-track-openvpn.sh "Pi4B UDP" pi@192.168.97.119 /dev/shm/openvpnserver-status_udp'
